<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FODO optics &mdash; PyTao 0.1.6 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="../dev_docs/api/index.html" />
    <link rel="prev" title="PyTao advanced usage" href="advanced.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> PyTao
          </a>
              <div class="version">
                0.1.6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user_docs/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_docs/interfaces.html">Scripting Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_docs/gui/index.html">Graphical Interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basic.html">PyTao basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html#Tao-method-commands">Tao method commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html#All-method-commands">All method commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html#Other-Tao-instances">Other Tao instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html#ParticleGroup-from-openPMD-beamphysics">ParticleGroup from openPMD-beamphysics</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html#Error-handling-and-Debugging">Error handling and Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">PyTao advanced usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">FODO optics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Symmetric-FODO">Symmetric FODO</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Asymmetric-FODO">Asymmetric FODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Plots">Plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Optimize-for-some-special-beta-functions">Optimize for some special beta functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Alternative-method:-alias">Alternative method: alias</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Beam-tracking">Beam tracking</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Get-particles">Get particles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Pretty-plot">Pretty plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Get-some-statistics">Get some statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Cleanup">Cleanup</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev_docs/api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_docs/documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_docs/development.html">Development Guidelines</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">External Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bmad-sim/pytao">PyTao GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.classe.cornell.edu/bmad">Bmad website</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.classe.cornell.edu/bmad/tao.html">Tao website</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PyTao</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>FODO optics</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/fodo.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="FODO-optics">
<h1>FODO optics<a class="headerlink" href="#FODO-optics" title="Permalink to this headline"></a></h1>
<p>This will demonstrate how to scan symmetrically and asymetrically the quadruople strengths in a standard FODO lattice.</p>
<p>Later we will optimize for particular average beta function.</p>
<p>Finally, we will track a beam and gather statistics from the particles.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from pytao import Tao
import numpy as np
import matplotlib.pyplot as plt
import os
%config InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>tao = Tao(&#39;-init $ACC_ROOT_DIR/tao/examples/fodo/tao.init -lat $ACC_ROOT_DIR/tao/examples/fodo/fodo.bmad -noplot&#39;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>def add_info(d):
    twiss1 = tao.ele_twiss(&#39;q1&#39;)
    twiss2 = tao.ele_twiss(&#39;q2&#39;)

    d[&#39;mean_beta_a&#39;] = (twiss1[&#39;beta_a&#39;] +  twiss2[&#39;beta_a&#39;])/2
    d[&#39;mean_beta_b&#39;] = (twiss1[&#39;beta_b&#39;] +  twiss2[&#39;beta_b&#39;])/2
    d[&#39;phi_a&#39;] = twiss2[&#39;phi_a&#39;]
    d[&#39;phi_b&#39;] = twiss2[&#39;phi_b&#39;]
    return d
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>%%tao
sho lat
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-------------------------
Tao&gt; sho lat
# Values shown are for the Exit End of each Element:
# Index  name      key                       s       l    beta   phi_a    eta   orbit    beta   phi_b    eta   orbit   Track
#                                                            a   [2pi]      x  x [mm]       b   [2pi]      y  y [mm]   State
      0  BEGINNING Beginning_Ele         0.000     ---    0.67   0.000   0.00   0.000    3.22   0.000   0.00   0.000   Alive
      1  P1        Pipe                  0.900   0.900    3.22   0.105   0.00   0.000    0.67   0.105   0.00   0.000   Alive
      2  Q1        Quadrupole            1.000   0.100    3.22   0.110   0.00   0.000    0.67   0.129   0.00   0.000   Alive
      3  P1        Pipe                  1.900   0.900    0.67   0.215   0.00   0.000    3.22   0.235   0.00   0.000   Alive
      4  Q2        Quadrupole            2.000   0.100    0.67   0.239   0.00   0.000    3.22   0.239   0.00   0.000   Alive
      5  END       Marker                2.000   0.000    0.67   0.239   0.00   0.000    3.22   0.239   0.00   0.000   Alive
Lord Elements:
      6  O_L       Overlay               1.900     ---    0.67   0.215   0.00     ---    3.22   0.235   0.00     ---   Not_Set
# Index  name      key                       s       l    beta   phi_a    eta   orbit    beta   phi_b    eta   orbit   Track
#                                                            a   [2pi]      x  x [mm]       b   [2pi]      y  y [mm]   State
# Values shown are for the Exit End of each Element:
-------------------------
Tao&gt;
</pre></div></div>
</div>
<div class="section" id="Symmetric-FODO">
<h2>Symmetric FODO<a class="headerlink" href="#Symmetric-FODO" title="Permalink to this headline"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>def set_kx(k1):
    cmds = [f&#39;set ele q1 k1 = {k1}&#39;,
            f&#39;set ele q2 k1 = {-k1}&#39;]

    d = {}
    try:
        tao.cmds(cmds)
        tao.cmd(&#39;set global lattice_calc_on = T&#39;)
        d[&#39;good&#39;] = True
        add_info(d)
    except:
        d[&#39;good&#39;] = False



    return d
x = set_kx(1.4142136E+01)
KEYS = x.keys()
x
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;good&#39;: True,
 &#39;mean_beta_a&#39;: 1.9442223177869156,
 &#39;mean_beta_b&#39;: 1.9442223177869151,
 &#39;phi_a&#39;: 1.50388821541239,
 &#39;phi_b&#39;: 1.5038882154124}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Scan k1
n1 = 20
qvec1 = np.linspace(1, 25, n1)

RESULTS = []

#tao.cmd(&#39;set global plot_on = F&#39;)
for k in qvec1:
    res = set_kx(k)
    RESULTS.append(res)
#tao.cmd(&#39;set global plot_on = T&#39;)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Reshape data
DAT = {}
for key in KEYS:
    print(key)
    x = []
    for res in RESULTS:
        if key in res:
            x.append(res[key])
        else:
            x.append(np.nan)
    DAT[key] = np.array(x)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
good
mean_beta_a
mean_beta_b
phi_a
phi_b
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>DAT.keys()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dict_keys([&#39;good&#39;, &#39;mean_beta_a&#39;, &#39;mean_beta_b&#39;, &#39;phi_a&#39;, &#39;phi_b&#39;])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>for key in KEYS:
    plt.plot(qvec1, DAT[key])
    plt.ylabel(key)
    plt.xlabel(r&#39;k1 (m$^{-2}$)&#39;)
    plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_fodo_10_0.png" class="no-scaled-link" src="../_images/examples_fodo_10_0.png" style="width: 385px; height: 264px;" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_fodo_10_1.png" class="no-scaled-link" src="../_images/examples_fodo_10_1.png" style="width: 392px; height: 264px;" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_fodo_10_2.png" class="no-scaled-link" src="../_images/examples_fodo_10_2.png" style="width: 392px; height: 264px;" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_fodo_10_3.png" class="no-scaled-link" src="../_images/examples_fodo_10_3.png" style="width: 386px; height: 264px;" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_fodo_10_4.png" class="no-scaled-link" src="../_images/examples_fodo_10_4.png" style="width: 386px; height: 264px;" />
</div>
</div>
</div>
</div>
<div class="section" id="Asymmetric-FODO">
<h1>Asymmetric FODO<a class="headerlink" href="#Asymmetric-FODO" title="Permalink to this headline"></a></h1>
<p>Scan k1 for each quad</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>def set_k(k1, k2):
    cmds = [f&#39;set ele q1 k1 = {k1}&#39;, f&#39;set ele q2 k1 = {-k2}&#39;]

    d = {}
    try:
        tao.cmds(cmds)
        tao.cmd(&#39;set global lattice_calc_on = T&#39;)
        d[&#39;good&#39;] = True
        add_info(d)
    except:
        d[&#39;good&#39;] = False



    return d
x = set_k(1.4142136E+01, 1.4142136E+01)
KEYS = x.keys()
x
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;good&#39;: True,
 &#39;mean_beta_a&#39;: 1.9442223177869156,
 &#39;mean_beta_b&#39;: 1.9442223177869151,
 &#39;phi_a&#39;: 1.50388821541239,
 &#39;phi_b&#39;: 1.5038882154124}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>set_k(1,1)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;good&#39;: True,
 &#39;mean_beta_a&#39;: 20.723056201983,
 &#39;mean_beta_b&#39;: 20.7230562019829,
 &#39;phi_a&#39;: 0.0966467384116863,
 &#39;phi_b&#39;: 0.0966467384116869}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>n1 = 50
n2 = 60
qvec1 = np.linspace(1, 15, n1)
qvec2 = np.linspace(1, 15, n2)
K1, K2 = np.meshgrid(qvec1, qvec2, indexing=&#39;ij&#39;)

fK1 = K1.flatten()
fK2 = K2.flatten()
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>%%time
# Make data

tao.cmd(&#39;set global plot_on = F&#39;)

RESULTS = []
for k1, k2 in zip(fK1, fK2):
    res = set_k(k1, k2)
#    print(res)
    RESULTS.append(res)


#tao.cmd(&#39;set global plot_on = T&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 3.41 s, sys: 2.02 s, total: 5.43 s
Wall time: 5.51 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Reshape data
DAT = {}
for key in RESULTS[0]:
    print(key)
    x = []
    for res in RESULTS:
        if key in res:
            x.append(res[key])
        else:
            x.append(np.nan)

    DAT[key] = np.array(x).reshape(n1, n2)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
good
mean_beta_a
mean_beta_b
phi_a
phi_b
</pre></div></div>
</div>
</div>
<div class="section" id="Plots">
<h1>Plots<a class="headerlink" href="#Plots" title="Permalink to this headline"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>NICE = {}
NICE[&#39;mean_beta_a&#39;] = r&#39;$&lt;\beta_x&gt;$&#39;
NICE[&#39;mean_beta_b&#39;] = r&#39;$&lt;\beta_y&gt;$&#39;
def nice(key):
    if key in NICE:
        return NICE[key]
    return key
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>#fig, ax = plt.subplots(figsize=(10,8))

def plot1(key):
    plt.imshow(DAT[key], origin=&#39;lower&#39;,
               extent=[qvec1.min(), qvec1.max(), qvec2.min(), qvec2.max()],
               cmap=&#39;jet&#39;,
              vmax = 10)
    plt.xlabel(&#39;Q1 (+)k1 (1/m$^2$)&#39;)
    plt.ylabel(&#39;Q2 (-)k1 (1/m$^2$)&#39;)
    plt.colorbar(label=nice(key))
    plt.show()
plot1(&#39;mean_beta_a&#39;)
plot1(&#39;mean_beta_b&#39;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_fodo_19_0.png" class="no-scaled-link" src="../_images/examples_fodo_19_0.png" style="width: 330px; height: 268px;" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_fodo_19_1.png" class="no-scaled-link" src="../_images/examples_fodo_19_1.png" style="width: 331px; height: 268px;" />
</div>
</div>
</div>
<div class="section" id="Optimize-for-some-special-beta-functions">
<h1>Optimize for some special beta functions<a class="headerlink" href="#Optimize-for-some-special-beta-functions" title="Permalink to this headline"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>def optimize(beta_a, beta_b):
    cmds = f&quot;&quot;&quot;
alias setbetas
veto var *
set lattice model=design
veto dat *
use dat fodo.betas[1,2]
set dat fodo.betas[1]|meas={beta_a}
set dat fodo.betas[2]|meas={beta_b}
use var quad
run
show var -bmad -good
    &quot;&quot;&quot;
    lines = tao.cmds(cmds.split(&#39;\n&#39;), suppress_lattice_calc=False, suppress_plotting=False, raises=False)

    # Twiss at Q1
    T = tao.ele_twiss(&#39;Q1&#39;)
    return T
optimize(10, 20)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;mode_flip&#39;: False,
 &#39;beta_a&#39;: 19.8980601747807,
 &#39;alpha_a&#39;: 20.8824960367291,
 &#39;gamma_a&#39;: 21.9658919957419,
 &#39;phi_a&#39;: 0.688888454799641,
 &#39;eta_a&#39;: 0.0,
 &#39;etap_a&#39;: 0.0,
 &#39;beta_b&#39;: 8.56179989648929,
 &#39;alpha_b&#39;: -8.68869255014027,
 &#39;gamma_b&#39;: 8.93426372441017,
 &#39;phi_b&#39;: 0.0669702646497163,
 &#39;eta_b&#39;: 0.0,
 &#39;etap_b&#39;: 0.0,
 &#39;eta_x&#39;: 0.0,
 &#39;etap_x&#39;: 0.0,
 &#39;eta_y&#39;: 0.0,
 &#39;etap_y&#39;: 0.0}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Check merit
tao.merit()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;  2.80064554015184E-23&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Check that the optimization worked
average_beta_a = tao.data(&#39;fodo&#39;, &#39;betas&#39;, dat_index=1)[&#39;model_value&#39;]
average_beta_b = tao.data(&#39;fodo&#39;, &#39;betas&#39;, dat_index=2)[&#39;model_value&#39;]
average_beta_a, average_beta_b
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(9.99999999999998, 20.0000000000017)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># These are the K
kq1 = tao.ele_gen_attribs(&#39;Q1&#39;)[&#39;K1&#39;]
kq2 = tao.ele_gen_attribs(&#39;Q2&#39;)[&#39;K1&#39;]
kq1, kq2
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(20.6297896339797, -10.5500557883925)
</pre></div></div>
</div>
</div>
<div class="section" id="Alternative-method:-alias">
<h1>Alternative method: alias<a class="headerlink" href="#Alternative-method:-alias" title="Permalink to this headline"></a></h1>
<p>A ‘simple’ Tao alias can be useful when running on the command line.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>tao.cmd(&#39;alias setbetas veto var *;veto dat *;use dat fodo.betas[1,2];set dat fodo.betas[1]|meas=[[1]];set dat fodo.betas[2]|meas=[[2]];use var quad;run;show var -bmad -good&#39;)
#tao.cmd(&#39;call SetBetas.tao&#39;, raises=False)

lines = tao.cmd(&#39;setbetas 40 25&#39;, raises=False)
lines[-3:];
tao.merit()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;  8.36381886151526E-24&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>T = tao.ele_twiss(&#39;Q1&#39;)
T
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;mode_flip&#39;: False,
 &#39;beta_a&#39;: 79.7708116314711,
 &#39;alpha_a&#39;: 83.9897718056194,
 &#39;gamma_a&#39;: 88.4444024532975,
 &#39;phi_a&#39;: 0.213283369019615,
 &#39;eta_a&#39;: 0.0,
 &#39;etap_a&#39;: 0.0,
 &#39;beta_b&#39;: 10.6890160749888,
 &#39;alpha_b&#39;: -10.8776594910373,
 &#39;gamma_b&#39;: 11.1631861310564,
 &#39;phi_b&#39;: 0.0536009562200217,
 &#39;eta_b&#39;: 0.0,
 &#39;etap_b&#39;: 0.0,
 &#39;eta_x&#39;: 0.0,
 &#39;etap_x&#39;: 0.0,
 &#39;eta_y&#39;: 0.0,
 &#39;etap_y&#39;: 0.0}
</pre></div></div>
</div>
</div>
<div class="section" id="Beam-tracking">
<h1>Beam tracking<a class="headerlink" href="#Beam-tracking" title="Permalink to this headline"></a></h1>
<p>Here we will make a new lattice with 10 cells that calls the single fodo lattice.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from pytao.misc.markers import make_markers
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>?make_markers
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">Signature:</span> make_markers<span class="ansi-blue-fg">(</span>slist<span class="ansi-blue-fg">,</span> filename<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> ref<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>
Makes markers relative to ref ele.

If filename is given, the lines will be written to ta file.
<span class="ansi-red-fg">File:</span>      ~/Code/GitHub/pytao/pytao/misc/markers.py
<span class="ansi-red-fg">Type:</span>      function

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>smax = 20.0 # m

# Alternatively, if the lattice were already loaded
#smax = tao.lat_list(&#39;*&#39;, who=&#39;ele.s&#39;).max()

slist = np.linspace(0, smax, 200)

make_markers(slist, filename=&#39;markers.bmad&#39;);

smax
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
20.0
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Make a lattice and write to a local file

latfile = os.path.join(os.getcwd(), &#39;fodo10.bmad&#39;)

LAT2 = f&quot;&quot;&quot;

call, file = $ACC_ROOT_DIR/tao/examples/fodo/fodo.bmad
call, file = markers.bmad

Q1[k1] = {kq1}
Q2[k1] = {kq2}

lat: line = (10*fodo1)

use, lat

&quot;&quot;&quot;
open(latfile, &#39;w&#39;).write(LAT2)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
172
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Run with this lattice
tao = Tao(f&#39;-init $ACC_ROOT_DIR/tao/examples/fodo/tao.init -lat {latfile} -noplot&#39;)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Toggle the beam on and off
tao.cmd(&#39;set beam_init n_particle = 1000&#39;)
tao.cmd(&#39;set global track_type = beam;set global track_type = single&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;&#39;,
 &#39;Tao: set global track_type = beam&#39;,
 &#39;&#39;,
 &#39;Tao: set global track_type = single&#39;]
</pre></div></div>
</div>
<div class="section" id="Get-particles">
<h2>Get particles<a class="headerlink" href="#Get-particles" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>import h5py
from pmd_beamphysics import ParticleGroup, particle_paths

with h5py.File(&#39;beam_dump.h5&#39;, &#39;r&#39;) as h5:
    pp = particle_paths(h5)
    Plist = [ParticleGroup(h5[g]) for g in pp]
</pre></div>
</div>
</div>
</div>
<div class="section" id="Pretty-plot">
<h2>Pretty plot<a class="headerlink" href="#Pretty-plot" title="Permalink to this headline"></a></h2>
<p>Traces can be made by gathering the coordinate arrays</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span>skip = 1 # make larger for faster plotting
fig, axes = plt.subplots(2, figsize=(12,8))

axes[0].plot(
    [P.t[::skip]*299792458 for P in  Plist],
    [P.x[::skip]*1e6 for P in  Plist],
    alpha=0.01, color=&#39;black&#39;
)

axes[1].plot(
    [P.t[::skip]*299792458 for P in  Plist],
    [P.y[::skip]*1e6 for P in  Plist],
    alpha=0.01, color=&#39;black&#39;
)

axes[0].set_ylabel(r&#39;$x$ (µm)&#39;)
axes[1].set_ylabel(r&#39;$y$ (µm)&#39;)

axes[1].set_xlabel(r&#39;$ct$ (m)&#39;)

for ax in axes:
    ax.set_ylim(-2000,2000)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_fodo_38_0.png" class="no-scaled-link" src="../_images/examples_fodo_38_0.png" style="width: 740px; height: 484px;" />
</div>
</div>
</div>
<div class="section" id="Get-some-statistics">
<h2>Get some statistics<a class="headerlink" href="#Get-some-statistics" title="Permalink to this headline"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>k1 = &#39;sigma_x&#39;
k2 = &#39;sigma_y&#39;

x =  np.array([P[&#39;mean_t&#39;]*299792458 for P in Plist])
y1 = np.array([P[k1] for P in Plist])
y2 = np.array([P[k2] for P in Plist])

fig, ax = plt.subplots(figsize=(12,4))
ax.plot(x, y1*1e6, label=k1)
ax.plot(x, y2*1e6, label=k2)
ax.set_xlabel(&#39;&lt;ct&gt; (m)&#39;)
ax.set_ylabel(f&#39;{k1}, {k2} (µm)&#39;)
plt.legend()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x162e6a070&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_fodo_40_1.png" class="no-scaled-link" src="../_images/examples_fodo_40_1.png" style="width: 724px; height: 261px;" />
</div>
</div>
</div>
<div class="section" id="Cleanup">
<h2>Cleanup<a class="headerlink" href="#Cleanup" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span># Cleanup
!rm beam_dump.h5
!rm {latfile}
!rm markers.bmad
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="advanced.html" class="btn btn-neutral float-left" title="PyTao advanced usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../dev_docs/api/index.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, David Sagan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>